<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8'>
		<title>Stundenplan</title>
		
		<style> 
			html, body {
				font-family: 'Trebuchet MS', sans-serif;
				color: {{font}};
				height: 100%;
				margin: 0;
				user-select: none;
			}
			body {
				background-color: {{dark}};
				display: flex;
				justify-content: center;
				align-items: center;
			}
			input[type=text], input[type=password] {
				background-color: {{input}};
				border: 3px solid {{accent}};
				box-sizing: border-box;
				border-top-style: none;
				border-radius: 0.5vh;
			}
			.button {
				background-color: {{input}};
				color: {{font}};
				cursor: pointer;
				/*margin-top: 10%;*/
				box-sizing: border-box;
				border: 3px solid {{light}};
				border-bottom-style: none;
				border-radius: 0.5vh;
				text-align: center;
			}
			.button:hover {
				border: 3px solid {{accent}};
				border-bottom-style: none;
			}
			input, label {
				width: 100%;
				padding: 10px;
			}
			a {
				width: 100%;
				text-align: center;
				margin-top: 20px;
				color: {{href}};
				font-size: 14px;
			}
			.outerdivs {
				display: flex;
				flex-flow: row nowrap;
				width: 90%;
				max-width: 90%;
			}
			#timetable {
				display: flex;
				flex-flow: column nowrap;
				justify-content: space-between;
				width: 100%;
				height: 100%;
			} 
			.day, .weekheader {
				height: 40px;
				width: 40px;
				border: 5px solid {{accent}};
				background-color: {{light}};
			}
			.week {
				display: flex;
				flex-flow: row nowrap;
				justify-content: space-between;
				width: 100%;
			}
			.weekheader {
				background-color: yellowgreen;
				font-size: 24px;
			}
			#container_left, #container_right {
				height: 100%;
				display: flex;
				flex-flow: column nowrap;
			}
			#container_left {
				width: 450px;
			}
			#container_right {
				width: 100%;
			}
			#inputDate {
				width: 100%;
				background-color: rgb(39, 85, 251);
				display: flex;
				flex-flow: row nowrap;
				justify-content: space-between;
			}
			#month_last_btn, #month_next_btn {
				width: 20px;
				height: 20px;
				background-color: black;
				color: white;
			}
		</style>

		<script src="{{url_for('static', filename='socketio_4.4.1.js')}}" crossorigin="anonymous"></script>
		<script src="{{url_for('static', filename='jquery_3.2.1.js')}}"></script>
		<script>

		var socket;
		var database = {};
		var cur_months = [];
		$(document).ready(function() {
			update_month_label();
			$(".day").click(function() {
				console.log(day_by_id(this.id));
			})

			socket = io.connect('/timetable/list');

			socket.on('connect', function() {
				//socket.emit('fetch', {sort: 'student_creation', order: 'desc', limit: 100, offset: 0});
				fetch_list();
			});
			
			socket.on('update', function(data) {
				console.log(data);
				
				database[data.year.toString() + "_" + data.month.toString()] = {init_day: data.init_day, month_length: data.month_length, data: data.data};
				
				update_calendar();

				return;
			});
		
		});

		function update_calendar() {
			if (cur_months[0] in database && cur_months[1] in database && cur_months[2] in database) {
				$('.day').each(function() {
					$(this).html(day_by_id(this.id).day);
					$(this).css("background-color", "{{light}}");
				});

				$.each(database[cur_months[1]].data, function(key, d) {
					$(id_by_day(d.date.day-1, 0)).css("background-color", "red");
				});
			}
		}

		function fetch_list(year, month) {
			if (month_sel === 1) {
				month_before = (year_sel - 1).toString() + "_12";
			}
			else {
				month_before = year_sel.toString() + "_" + (month_sel - 1).toString();
			}
			if (month_sel === 12) {
				month_after = (year_sel + 1).toString() + "_1";
			}
			else {
				month_after = year_sel.toString() + "_" + (month_sel + 1).toString();
			}
			cur_months = [month_before, (year_sel.toString() + "_" + month_sel.toString()), month_after];
			console.log(cur_months);

			local_update = 0 // if reaches 3 (all 3 datasets available local) it will trigger gui update, else it will wait for missing package to trigger update
			if (month_before in database) {
				local_update++;
			}
			else {
				socket.emit('fetch', {year: month_before.split('_')[0], month: month_before.split('_')[1]});
			}
			if (cur_months[1] in database) {
				local_update++;
			}
			else {
				socket.emit('fetch', {year: year_sel.toString(), month: month_sel.toString()});
			}
			if (month_after in database) {
				local_update++;
			}
			else {
				socket.emit('fetch', {year: month_after.split('_')[0], month: month_after.split('_')[1]});
			}			
			
			if (local_update === 3) {
				update_calendar();
			}
		};

		function id_by_day(day, month) {
			if (day < 0) {
				return null;
			}
			else if (month === -1) {
				return "#day" + day;
			}
			else if (month === 0) {
				return "#day" + (day + database[cur_months[1]].init_day);
			}
			else if (month === 1) {
				return "#day" + (day + database[cur_months[1]].init_day + database[cur_months[1]].month_length)
			}
			return null;
		};

		function day_by_id(id) {
			grid_id = Number(id.slice(3)) + 1;
			if (grid_id > database[cur_months[1]].init_day + database[cur_months[1]].month_length) {
				return {month: 1, day: grid_id - database[cur_months[1]].init_day - database[cur_months[1]].month_length};
			}
			else if (grid_id > database[cur_months[1]].init_day) {
				return {month: 0, day: grid_id - database[cur_months[1]].init_day};
			}
			else {
				return {month: -1, day: database[cur_months[0]].month_length - database[cur_months[1]].init_day + grid_id};
			}
		}
		
		var month_sel = {{cur_month}};
		var year_sel = {{cur_year}};
		function month_next() {
			if (month_sel === 12) {
				month_sel = 1;
				year_sel++;
			}
			else {
				month_sel++;
			}
			update_month_label();
			fetch_list();
		}
		function month_last() {
			if (month_sel === 1) {
				month_sel = 12;
				year_sel--;
			}
			else {
				month_sel--;
			}
			update_month_label();
			fetch_list();
		}
		function update_month_label() {
			$('#month_selected_label').text(["Januar", "Februar", "MÃ¤rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"][month_sel-1] + " " + year_sel);
		}

		</script>
	</head>
	<body>
		<div class="outerdivs">	
			
			<div id="container_left">
				<div id="inputDate">
					<div id="month_last_btn" onclick="month_last()">&lt;</div>
					<div id="month_selected_label" onclick="month_last()"></div>
					<div id="month_next_btn" onclick="month_next()">&gt;</div>
				</div>

				<div id="timetable">
					<div class="week" id="weekheader">
						<div class="weekheader" id="weekheader0">Mo</div>
						<div class="weekheader" id="weekheader1">Di</div>
						<div class="weekheader" id="weekheader2">Mi</div>
						<div class="weekheader" id="weekheader3">Do</div>
						<div class="weekheader" id="weekheader4">Fr</div>
						<div class="weekheader" id="weekheader5">Sa</div>
						<div class="weekheader" id="weekheader6">So</div>
					</div>
					<div class="week" id="week0">
						<div class="day" id="day0"></div>
						<div class="day" id="day1"></div>
						<div class="day" id="day2"></div>
						<div class="day" id="day3"></div>
						<div class="day" id="day4"></div>
						<div class="day" id="day5"></div>
						<div class="day" id="day6"></div>
					</div>
					<div class="week" id="week1">
						<div class="day" id="day7"></div>
						<div class="day" id="day8"></div>
						<div class="day" id="day9"></div>
						<div class="day" id="day10"></div>
						<div class="day" id="day11"></div>
						<div class="day" id="day12"></div>
						<div class="day" id="day13"></div>
					</div>
					<div class="week" id="week2">
						<div class="day" id="day14"></div>
						<div class="day" id="day15"></div>
						<div class="day" id="day16"></div>
						<div class="day" id="day17"></div>
						<div class="day" id="day18"></div>
						<div class="day" id="day19"></div>
						<div class="day" id="day20"></div>
					</div>
					<div class="week" id="week3">
						<div class="day" id="day21"></div>
						<div class="day" id="day22"></div>
						<div class="day" id="day23"></div>
						<div class="day" id="day24"></div>
						<div class="day" id="day25"></div>
						<div class="day" id="day26"></div>
						<div class="day" id="day27"></div>
					</div>
					<div class="week" id="week4">
						<div class="day" id="day28"></div>
						<div class="day" id="day29"></div>
						<div class="day" id="day30"></div>
						<div class="day" id="day31"></div>
						<div class="day" id="day32"></div>
						<div class="day" id="day33"></div>
						<div class="day" id="day34"></div>
					</div>
					<div class="week" id="week5">
						<div class="day" id="day35"></div>
						<div class="day" id="day36"></div>
						<div class="day" id="day37"></div>
						<div class="day" id="day38"></div>
						<div class="day" id="day39"></div>
						<div class="day" id="day40"></div>
						<div class="day" id="day41"></div>
					</div>
				</div>
			</div>

			<div id="container_right">

			</div>

		</div>
	</body>
</html>
